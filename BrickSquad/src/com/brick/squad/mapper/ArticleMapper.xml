<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.brick.squad.mapper.ArticleMapper">

	<!-- 查询 -->
	<select id="findArticleById" resultType="article" parameterType="String">
		select id,aname aname,type_id typeId,business_id
		businessId,describes,price,stock,image from article where id=#{id}
	</select>

	<insert id="insertArticle" parameterType="article">
		<selectKey resultType="String" keyProperty="id" order="BEFORE">
			select replace(uuid(),'-','') from dual
		</selectKey>
		insert into
		article(id,aname,type_id,business_id,price,stock,describes,image)
		values(#{id},#{aname},#{typeId},#{businessId},#{price},#{stock},#{describes},#{id})
	</insert>

	<delete id="deleteArticleById" parameterType="String">
		delete from article
		where id=#{id}
	</delete>

	<update id="updateArticleById" parameterType="article">
		update article set

		aname=#{aname},
		type_id=#{typeId},
		business_id=#{businessId},
		price=#{price},
		stock=#{stock},
		describes=#{describes},
		image=#{image}
		where id = #{id}
	</update>


	<select id="articlePagination" parameterType="com.brick.squad.util.Pagination"
		resultType="com.brick.squad.expand.ArticleExpand">
		SELECT a.id,a.aname,t.`name` tname,a.price,a.stock,b.`name`
		bname,a.describes
		FROM article a INNER JOIN type t ON a.type_id = t.id
		INNER JOIN business b
		ON a.business_id = b.id
		<if test="keyword!=''">
			where a.aname REGEXP #{keyword} or t.`name` REGEXP
			#{keyword} or b.`name`
			REGEXP #{keyword} or a.describes REGEXP
			#{keyword}
		</if>
		limit #{skipNum},#{takeNum}

	</select>


	<select id="findArticleAllCount" resultType="int"
		parameterType="com.brick.squad.util.Pagination">
		select
		count(*) FROM article a INNER JOIN type t ON a.type_id = t.id
		INNER JOIN business b
		ON a.business_id = b.id
		<if test="keyword!=''">
			where a.aname REGEXP #{keyword} or t.`name` REGEXP
			#{keyword} or b.`name`
			REGEXP #{keyword} or a.describes REGEXP
			#{keyword}
		</if>
	</select>
	<select id="findArticle" resultType="com.brick.squad.util.Select">
		SELECT id,aname name
		FROM
		article
	</select>

	<!-- <select id="findAllArticle" resultType="article"> select article.type_id 
		typeId from article </select> -->
	<select id="findAllTypeAndBusiness" resultType="article">
		SELECT
		a.id,a.aname,a.type_id typeId,a.business_id businessId,t.`name`
		tname,a.price,a.stock,b.`name`
		bname,a.describes
		FROM article a INNER
		JOIN type t ON a.type_id = t.id INNER JOIN business b
		ON a.business_id
		= b.id
	</select>

	<select id="findAllArticle" resultType="com.brick.squad.expand.ArticleExpand">
		SELECT
		a.id,a.aname,t.`name` tname,a.price,a.stock,b.`name`
		bname,a.describes
		FROM article a INNER JOIN type t ON a.type_id = t.id
		INNER JOIN
		business b
		ON a.business_id = b.id
	</select>


	<select id="findArticleAndTypeAndBusiness" parameterType="java.lang.String"
		resultType="com.brick.squad.expand.ArticleExpand">
		SELECT a.id,a.aname,t.`name` tname,a.price,a.stock,b.`name`
		bname,a.describes,a.image
		FROM article a INNER JOIN type t ON a.type_id
		= t.id INNER JOIN business b
		ON a.business_id = b.id
		WHERE a.id =
		#{id,jdbcType=VARCHAR}

	</select>


	<select id="findArticleBuyNumber" resultType="com.brick.squad.expand.ArticleExpand">
		SELECT
		id,aname,buyNumber,price,image from article a JOIN
		(select count(*) buyNumber,article_id
		FROM order_details GROUP BY article_id ORDER BY buyNumber DESC) o on
		a.id=o.article_id

	</select>
	<!-- 医疗器械查询 -->
	<select id="findArticleImgAndName" resultType="article"
		parameterType="java.lang.String">
		SELECT id ,aname ,image
		FROM article
		WHERE article.type_id=#{typeId}
	</select>
	<select id="selectArticleSalesNumberTotalById" resultType="int"
		parameterType="java.lang.String">
		select sum(number) NumberTotal from order_details where
		article_id =#{id}
	</select>

	<select id="selectArticleRatedTotalById" resultType="int"
		parameterType="java.lang.String">
		select count(rated.id) ratedTotal from rated JOIN order_details on
		rated.order_id =order_details.orders_id and order_details.article_id
		=#{id}
		</select>
	<!-- 医疗器械热门商品查询 -->
	<select id="findArticleBuyNumberAndMedicle"  resultType="com.brick.squad.expand.ArticleExpand"
	parameterType="java.lang.String">
			SELECT a.id,aname,buyNumber,price,image 
			FROM article a JOIN 
			(SELECT COUNT(*) buyNumber,article_id
			FROM order_details GROUP BY article_id ORDER BY buyNumber DESC) 
			o ON a.id=o.article_id JOIN type t ON  t.id=a.type_id 
			WHERE t.parent_id=#{parentId}
</select>
	<select id="selectArticleSalesNumberTotalById" resultType="int" parameterType="java.lang.String">
		select sum(number) NumberTotal from order_details  where article_id =#{id}
	</select>

</mapper>
